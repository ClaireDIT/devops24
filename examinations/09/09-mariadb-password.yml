---
- hosts: db
  become: true

  vars:
    mysql_webapp_password: !vault |
       $ANSIBLE_VAULT;1.1;AES256
       37313565336230306361663932363866313962303865333931643466336331626337366637623961
       6663653833383434303366616237363731643634643534300a666335346663613462626639616336
       32303138663238356261383230663932313462336138353864376233666366393438393437366239
       3033323437613833380a353836396265663862333362313639363232353136613838396435636639
       6261





  tasks:
    - name: Ensure MariaDB-server and Pymysql is installed.
      ansible.builtin.package:
        name:
          - mariadb-server
          - python3-PyMySQL
        state: present

    - name: Ensure MariaDB service is enabled and started
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: true

    - name: Create webappdb database
      community.mysql.mysql_db:
        name: webappdb
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock

    - name: Create webappuser and grant privileges
      community.mysql.mysql_user:
        name: webappuser
        password: "{{ mysql_webapp_password }}"
        priv: "webappdb.*:ALL"
        state: present
        login_unix_socket: /var/lib/mysql/mysql.sock

